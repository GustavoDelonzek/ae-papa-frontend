<app-sidebar></app-sidebar>
<div class="patient-page-container">
  <!-- Top Navigation Bar -->
  <header class="top-nav">
    <div class="back-link" (click)="goBack()">
      <i class="fas fa-arrow-left"></i>
      <span>Voltar para lista</span>
    </div>
    <div class="top-actions">
      <!-- Clinical Record Button (Dynamic) -->
      <button class="btn-primary" (click)="handleClinicalRecordAction()">
        <ng-container *ngIf="!existingClinicalRecord">
          <i class="fas fa-plus"></i> Adicionar Registro Clínico
        </ng-container>
        <ng-container *ngIf="existingClinicalRecord">
          <i class="fas fa-file-medical"></i> Visualizar Registro Clínico
        </ng-container>
      </button>

      <button class="btn-secondary" (click)="openEditModal()">
        <i class="fas fa-pen"></i> Editar Perfil
      </button>
    </div>
  </header>

  <div class="main-content" *ngIf="loading">
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Carregando dados...</p>
    </div>
  </div>

  <div class="main-content" *ngIf="errorMessage && !loading">
    <div class="error-state">
      <i class="fas fa-exclamation-circle"></i>
      <p>{{ errorMessage }}</p>
      <button class="btn-secondary" (click)="goBack()">Voltar</button>
    </div>
  </div>

  <div class="main-content" *ngIf="patientData && !loading">
    <!-- Profile Header Card -->
    <div class="profile-header-card">
      <div class="profile-content">
        <div class="profile-image-container">
          <div class="profile-image">
            <img [src]="patientData.photo || 'assets/default-avatar.png'" alt="Foto do Paciente"
              *ngIf="patientData.photo">
            <div class="avatar-placeholder" *ngIf="!patientData.photo">
              <span>{{ patientData.full_name.charAt(0) }}</span>
            </div>
          </div>
        </div>

        <div class="profile-info">
          <div class="profile-name-row">
            <h1>{{ patientData.full_name }}</h1>
          </div>

          <div class="profile-stats-row">
            <div class="stat-item">
              <span class="stat-label">IDADE</span>
              <span class="stat-value">{{ getPatientAge() }} anos</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">GÊNERO</span>
              <span class="stat-value">{{ getGenderText() }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ESTADO CIVIL</span>
              <span class="stat-value">{{ getMaritalStatusText() }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">CPF</span>
              <span class="stat-value">{{ formatCPF(patientData.cpf) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <nav class="page-tabs">
      <button class="tab-btn" [class.active]="isTabActive('detalhes')" (click)="selectTab('detalhes')">Detalhes</button>
      <button class="tab-btn" [class.active]="isTabActive('documentos')"
        (click)="selectTab('documentos')">Documentos</button>
      <button class="tab-btn" [class.active]="isTabActive('Cuidador')" (click)="selectTab('Cuidador')">Cuidador</button>
      <button class="tab-btn" [class.active]="isTabActive('consultas')" (click)="selectTab('consultas')">Histórico de
        Consultas</button>
    </nav>

    <!-- Tab Content -->
    <div class="tab-content-area">

      <!-- DETALHES TAB -->
      <div *ngIf="activeTab === 'detalhes'" class="details-tab fade-in">



        <!-- Personal Info Section -->
        <section class="info-section">
          <h2 class="section-title">
            <i class="far fa-user"></i> Informações Pessoais
          </h2>
          <div class="info-grid">
            <div class="info-card">
              <label>CPF</label>
              <div class="value">{{ formatCPF(patientData.cpf) }}</div>
            </div>
            <div class="info-card">
              <label>RG</label>
              <div class="value">{{ patientData.rg || 'Não informado' }}</div>
            </div>
            <div class="info-card">
              <label>DATA DE NASCIMENTO</label>
              <div class="value">{{ formatDate(patientData.birth_date) }}</div>
            </div>
          </div>
        </section>

        <!-- Registry History Section -->
        <section class="info-section">
          <h2 class="section-title">
            <i class="fas fa-history"></i> Histórico do Registro
          </h2>
          <div class="info-grid">
            <div class="info-card">
              <label>DATA DE CADASTRO</label>
              <div class="value">{{ formatDate(patientData.created_at || '') }}</div>
              <i class="far fa-calendar-alt card-icon"></i>
            </div>
            <div class="info-card">
              <label>ÚLTIMA ATUALIZAÇÃO</label>
              <div class="value">{{ formatDate(patientData.updated_at || '') }}</div>
              <i class="fas fa-history card-icon"></i>
            </div>
          </div>
        </section>

        <!-- Socioeconomic Context Section -->
        <section class="info-section">
          <div class="section-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 class="section-title" style="margin-bottom: 0;">
              <i class="fas fa-hand-holding-usd"></i> Perfil Socioeconômico
            </h2>
            <button class="btn-primary-small" (click)="openSocioeconomicModal()">
              <i class="fas" [ngClass]="patientData?.socioeconomic_profile ? 'fa-pen' : 'fa-plus'"></i>
              {{ patientData?.socioeconomic_profile ? 'Editar' : 'Preencher' }}
            </button>
          </div>

          <div class="info-grid" *ngIf="patientData?.socioeconomic_profile">
            <!-- Occupação (JSON or String) -->
            <div class="info-card">
              <label>OCUPAÇÃO</label>
              <div class="value">{{ getIncomeDisplay(patientData!.socioeconomic_profile!.income_source) }}</div>
            </div>
            <div class="info-card">
              <label>MORADIA</label>
              <div class="value">{{ patientData?.socioeconomic_profile?.housing_ownership || 'Não informado' }}</div>
            </div>
            <div class="info-card">
              <label>CONSTRUÇÃO</label>
              <div class="value">{{ patientData?.socioeconomic_profile?.construction_type || 'Não informado' }}</div>
            </div>
            <!-- Sanitation (JSON) -->
            <div class="info-card" style="grid-column: span 2;">
              <label>SANEAMENTO</label>
              <div class="value" style="font-size: 0.9rem;">
                {{ getSanitationDisplay(patientData!.socioeconomic_profile!.sanitation_details) }}
              </div>
            </div>
          </div>
          <div class="empty-state-small" *ngIf="!patientData?.socioeconomic_profile"
            style="background: #F3F4F6; padding: 1.5rem; text-align: center; border-radius: 8px;">
            <p style="color: #6B7280; font-style: italic;">Nenhum dado socioeconômico registrado.</p>
          </div>
        </section>




      </div>

      <!-- DOCUMENTOS TAB (Existing Component) -->
      <div *ngIf="activeTab === 'documentos'" class="documents-tab fade-in">
        <app-document-list [patientId]="patientId" (onUploadClick)="addDocument()">
        </app-document-list>
      </div>

      <!-- CUIDADOR TAB -->
      <div *ngIf="activeTab === 'Cuidador'" class="caretaker-tab fade-in">
        <div class="caretaker-header-actions">
          <h2>Cuidadores</h2>
          <button class="btn-primary-small" (click)="addCaretaker()">
            <i class="fas fa-plus"></i> Novo Cuidador
          </button>
        </div>

        <div class="loading-state" *ngIf="loadingCaretakers">
          <div class="spinner"></div>
        </div>

        <div class="empty-state" *ngIf="!loadingCaretakers && caretakers.length === 0">
          <i class="fas fa-user-nurse"></i>
          <p>Nenhum cuidador vinculado.</p>
        </div>

        <div class="caretaker-grid" *ngIf="!loadingCaretakers && caretakers.length > 0">
          <div class="caretaker-card-item" *ngFor="let caretaker of caretakers" (click)="viewCaretaker(caretaker.id!)">
            <div class="card-header">
              <span class="name">{{ caretaker.full_name }}</span>
              <div class="actions">
                <button (click)="caretaker.id && editCaretaker(caretaker.id); $event.stopPropagation()"><i
                    class="fas fa-edit"></i></button>
                <button (click)="caretaker.id && deleteCaretaker(caretaker.id); $event.stopPropagation()"
                  class="delete"><i class="fas fa-trash"></i></button>
              </div>
            </div>
            <div class="card-body">
              <div class="detail-row">
                <i class="fas fa-id-card"></i> <span>{{ formatCPF(caretaker.cpf) }}</span>
              </div>
              <div class="detail-row" *ngIf="caretaker.kinship">
                <i class="fas fa-heart"></i> <span>{{ getKinshipText(caretaker.kinship) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONSULTAS TAB -->
      <div *ngIf="activeTab === 'consultas'" class="appointments-tab fade-in">
        <div class="appointments-header-actions">
          <h2>Histórico de Consultas</h2>
          <button class="btn-primary-small" (click)="openCreateAppointmentModal()">
            <i class="fas fa-plus"></i> Nova Consulta
          </button>
        </div>

        <div class="loading-state" *ngIf="loadingAppointments">
          <div class="spinner"></div>
        </div>

        <div class="empty-state" *ngIf="!loadingAppointments && appointments.length === 0">
          <i class="fas fa-calendar-check"></i>
          <p>Nenhuma consulta registrada.</p>
        </div>

        <div class="appointments-list" *ngIf="!loadingAppointments && appointments.length > 0">
          <div class="appointment-item" *ngFor="let appointment of appointments"
            (click)="viewAppointment(appointment.id!)">
            <div class="date-badge">
              <span class="day">{{ formatAppointmentDate(appointment.date).split('/')[0] }}</span>
              <span class="month">{{ formatAppointmentDate(appointment.date).split('/')[1] }}</span>
              <span class="year">{{ formatAppointmentDate(appointment.date).split('/')[2] }}</span>
            </div>
            <div class="appt-details">
              <h3>{{ getObjectiveText(appointment.objective) }}</h3>
              <p class="obs" *ngIf="appointment.observations">{{ appointment.observations }}</p>
              <span class="status-tag" [ngClass]="appointment.status || 'pending'">
                {{ getStatusText(appointment.status || 'pending') }}
              </span>
            </div>
            <div class="appt-actions">
              <button (click)="viewAppointment(appointment.id!); $event.stopPropagation()" class="btn-icon">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>



    </div>
  </div>
</div>

<!-- Modals (Upload, Appointment) -->
<app-document-upload *ngIf="showUploadModal" [patientId]="patientId" [user_id]="currentUserId"
  (onClose)="closeUploadModal()" (onSuccess)="onDocumentUploadSuccess()">
</app-document-upload>

<div class="modal-overlay" *ngIf="showAppointmentModal" (click)="closeAppointmentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Nova Consulta</h2>
      <button class="btn-close" (click)="closeAppointmentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="createAppointment()" #appointmentForm="ngForm">
        <div class="form-group">
          <label>Paciente</label>
          <input type="text" class="form-control" [value]="patientData?.full_name" disabled>
        </div>

        <div class="form-group">
          <label>Data da Consulta *</label>
          <input type="date" name="date" class="form-control" [(ngModel)]="newAppointment.date" required>
        </div>

        <div class="form-group">
          <label>Objetivo *</label>
          <select name="objective" class="form-control" [(ngModel)]="newAppointment.objective" required>
            <option value="" disabled selected>Selecione...</option>
            <option value="donation">Doação</option>
            <option value="project">Projeto</option>
            <option value="treatment">Tratamento</option>
            <option value="research">Pesquisa</option>
            <option value="other">Outro</option>
          </select>
        </div>

        <div class="form-group">
          <label>Observações</label>
          <textarea name="observations" class="form-control" rows="4"
            [(ngModel)]="newAppointment.observations"></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeAppointmentModal()">Cancelar</button>
          <button type="submit" class="btn-submit" [disabled]="!appointmentForm.form.valid || savingAppointment">
            <span *ngIf="!savingAppointment">Agendar</span>
            <span *ngIf="savingAppointment"><i class="fas fa-spinner fa-spin"></i></span>
          </button>
        </div>
      </form>
      <div class="alert-error" *ngIf="appointmentErrorMessage">
        {{ appointmentErrorMessage }}
      </div>
    </div>
  </div>
</div>

<!-- Edit Patient Modal -->
<app-patient-form-modal [visible]="showEditModal" [patient]="patientData" (close)="closeEditModal()"
  (success)="onEditSuccess()">
</app-patient-form-modal>

<!-- Caretaker Modal -->
<app-caretaker-form-modal [visible]="showCaretakerModal" [patientId]="patientId" [caretaker]="currentCaretaker"
  (close)="closeCaretakerModal()" (success)="onCaretakerSuccess()">
</app-caretaker-form-modal>

<!-- Socioeconomic Profile Modal -->
<app-socioeconomic-profile-modal [visible]="showSocioeconomicModal" [patientId]="patientId"
  [profile]="patientData?.socioeconomic_profile || null" (close)="closeSocioeconomicModal()"
  (success)="onSocioeconomicSuccess($event)">
</app-socioeconomic-profile-modal>

<!-- Clinical Record Modal -->
<app-clinical-record-modal [visible]="showClinicalRecordModal" [patientId]="patientId"
  [patientName]="patientData?.full_name || ''" [record]="currentClinicalRecord" (close)="closeClinicalRecordModal()"
  (success)="onClinicalRecordSuccess($event)">
</app-clinical-record-modal>

<!-- Appointment Details Modal -->
<app-appointment-details-modal [visible]="showDetailsModal" [appointment]="selectedAppointment"
  (close)="closeDetailsModal()" (edit)="onEditAppointmentDetails($event)">
</app-appointment-details-modal>
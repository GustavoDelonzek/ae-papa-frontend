<div class="modal-overlay" *ngIf="visible" (click)="onClose()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ isEditing ? 'Editar Cuidador' : 'Novo Cuidador' }}</h2>
            <button class="btn-close" (click)="onClose()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-body">
            <form (ngSubmit)="save()" #createForm="ngForm">

                <!-- Patient Selection (only when no patientId is provided) -->
                <div class="form-group" *ngIf="needsPatientSelection">
                    <label>Paciente *</label>
                    <div class="patient-search-container">
                        <div class="search-input-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control search-input" [(ngModel)]="patientSearchTerm"
                                name="patientSearch" (input)="onPatientSearch()" (focus)="showPatientDropdown = true"
                                placeholder="Buscar por nome ou CPF..." autocomplete="off"
                                [disabled]="selectedPatient !== null">
                            <button type="button" class="btn-clear" *ngIf="selectedPatient"
                                (click)="clearPatientSelection()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Patient Dropdown -->
                        <div class="patient-dropdown" *ngIf="showPatientDropdown && !selectedPatient">
                            <div class="dropdown-loading" *ngIf="loadingPatients">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                            <div class="dropdown-empty" *ngIf="!loadingPatients && filteredPatients.length === 0">
                                Nenhum paciente encontrado
                            </div>
                            <div class="patient-option" *ngFor="let patient of filteredPatients"
                                (click)="selectPatient(patient)">
                                <div class="patient-avatar">{{ patient.full_name.charAt(0) }}</div>
                                <div class="patient-info">
                                    <span class="patient-name">{{ patient.full_name }}</span>
                                    <span class="patient-cpf">{{ formatPatientCPF(patient.cpf) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Patient Badge -->
                    <div class="selected-patient-badge" *ngIf="selectedPatient">
                        <i class="fas fa-user-check"></i>
                        <span>{{ selectedPatient.full_name }}</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="full_name" class="form-control" [(ngModel)]="currentCaretaker.full_name"
                        required placeholder="Nome do cuidador">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Data de Nascimento *</label>
                        <input type="date" name="birth_date" class="form-control"
                            [(ngModel)]="currentCaretaker.birth_date" required>
                    </div>

                    <div class="form-group">
                        <label>Gênero *</label>
                        <select name="gender" class="form-control" [(ngModel)]="currentCaretaker.gender" required>
                            <option value="" disabled>Selecione...</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>CPF *</label>
                        <input type="text" name="cpf" class="form-control" [(ngModel)]="currentCaretaker.cpf" required
                            (input)="formatCPF($event)" maxlength="14" placeholder="000.000.000-00">
                    </div>

                    <div class="form-group">
                        <label>RG</label>
                        <input type="text" name="rg" class="form-control" [(ngModel)]="currentCaretaker.rg"
                            placeholder="Opcional">
                    </div>
                </div>

                <div class="form-group" *ngIf="!isEditing">
                    <label>Parentesco/Relação *</label>
                    <select name="kinship" class="form-control" [(ngModel)]="currentCaretaker.kinship"
                        [required]="!isEditing">
                        <option value="" disabled selected>Selecione...</option>
                        <option value="son">Filho</option>
                        <option value="daughter">Filha</option>
                        <option value="spouse">Cônjuge</option>
                        <option value="partner">Companheiro(a)</option>
                        <option value="father">Pai</option>
                        <option value="mother">Mãe</option>
                        <option value="brother">Irmão</option>
                        <option value="sister">Irmã</option>
                        <option value="grand_son">Neto</option>
                        <option value="grand_daughter">Neta</option>
                        <option value="nephew">Sobrinho</option>
                        <option value="niece">Sobrinha</option>
                        <option value="friend">Amigo(a)</option>
                        <option value="professional_caregiver">Cuidador Profissional</option>
                        <option value="other">Outro</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" (click)="onClose()">Cancelar</button>
                    <button type="submit" class="btn-submit" [disabled]="isSaving">
                        <span *ngIf="!isSaving">{{ isEditing ? 'Atualizar' : 'Salvar' }}</span>
                        <span *ngIf="isSaving"><i class="fas fa-spinner fa-spin"></i></span>
                    </button>
                </div>
            </form>

            <div class="alert-error" *ngIf="errorMessage">
                {{ errorMessage }}
            </div>
        </div>
    </div>
</div>